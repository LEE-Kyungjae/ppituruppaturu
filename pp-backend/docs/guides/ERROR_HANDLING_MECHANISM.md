<!-- /Users/ze/work/go/docs/ERROR_HANDLING_MECHANISM.md -->
# 오류 처리 메커니즘 (Gemini CLI 무한루프 방지)

## 목적
- 반복 루프(동일 제안 반복, “계속 진행하겠습니다” 등)를 3회 이내로 종결
- 실패 시 자동으로 오류 리포트를 생성하고 외부 지원을 요청

## 공통 규칙
- 모든 세션은 **두 단계 응답**을 강제:
  1) `PLAN`(분석·계획) → 2) `APPLY`(코드/명령/패치)
- No-Op(동일 조치 반복) 금지: **이전 시도 대비 “변경점”을 명시**하지 않으면 APPLY 불가
- 출력 형식은 반드시 아래 블록을 포함:
  - ```plan
    # PLAN
    ```
  - ```diff
    # APPLY (unified diff 또는 명령 집합)
    ```
  - ```log
    # EVIDENCE (테스트/빌드 로그 요약)
    ```

## 시도 상한
- `MAX_TRIES = 3`
- 각 시도는 다음 순서를 지킴:
  1) 오류 인용(원문 3~6줄)
  2) 원인 가설(최대 3개, 우선순위)
  3) 변경점(이전 시도와 비교한 차이 1~3개)
  4) 최소 변경 패치(APPLY)
  5) 검증(EVIDENCE: 빌드/테스트 결과 핵심 10줄 이내)

## 루프 판정 조건(아래 중 하나라도 참이면 같은 루프로 본다)
- 동일/유사 문장 반복(레벤슈타인 거리 또는 해시 충돌)
- `APPLY`가 비어있거나 이전 시도와 동일
- “파일을 읽었습니다/계속 진행” 등 **메타 문장만 출력**

## 탈출 및 에스컬레이션
- 3회 실패 또는 루프 판정 발생 시 즉시 종료하고 `reports/ERROR_REPORT_YYYYMMDD_HHMMSS.md` 생성
- 리포트 생성 후 “외부 도움 요청 프롬프트”에 첨부하여 재시도는 금지

## 감사 로깅
- `logs/gem_runs/YYYYMMDD/session.log`에 입력·출력 원문, 시도별 해시, 종료 사유 저장