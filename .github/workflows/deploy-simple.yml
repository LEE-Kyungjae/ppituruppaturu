name: Simple Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: ze2l/ppituruppaturu

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Info & Debug
        run: |
          docker version
          docker buildx version
          docker buildx ls
          echo "=== Backend Context ==="
          ls -lah ./pp-backend
          test -f ./pp-backend/Dockerfile && echo "Backend Dockerfile found"
          echo "=== Frontend Context ==="
          ls -lah ./pp-frontend
          test -f ./pp-frontend/Dockerfile && echo "Frontend Dockerfile found"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Backend Image
      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./pp-backend
          file: ./pp-backend/Dockerfile
          target: production
          platforms: linux/amd64
          push: true
          no-cache: true
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
          outputs: type=registry

      # Build Frontend Image
      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./pp-frontend
          file: ./pp-frontend/Dockerfile
          target: production
          platforms: linux/amd64
          push: true
          no-cache: true
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
          outputs: type=registry

      # Deploy to Production
      - name: Check deployment prerequisites
        run: |
          echo "üîç Checking deployment prerequisites..."
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
          echo "DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}"
          echo "SSH key length: ${#DEPLOY_SSH_KEY}"
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Test SSH connection
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "üîê Testing SSH connection..."
          ssh -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful!'"

      - name: Deploy to server (Blue/Green)
        run: |
          set -euxo pipefail

          echo "üìÅ Uploading deployment files..."
          scp -v deploy-blue-green.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pitturu/
          scp -v docker-compose.blue.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pitturu/
          scp -v docker-compose.green.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/pitturu/
          scp -v nginx-blue.conf ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          scp -v nginx-green.conf ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/

          echo "üöÄ Starting Blue/Green deployment..."
          ssh -v ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -euxo pipefail
            cd /opt/pitturu

            echo "üìÅ Current directory: $(pwd)"
            echo "üìÅ Directory contents:"
            ls -la

            echo "üîß Setting up Nginx configuration..."
            sudo mkdir -p /etc/nginx/upstreams
            sudo mkdir -p /etc/nginx/conf.d
            sudo mv /tmp/nginx-blue.conf /etc/nginx/upstreams/app-blue.conf
            sudo mv /tmp/nginx-green.conf /etc/nginx/upstreams/app-green.conf

            echo "üîê Docker Hub login..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            echo "üéØ Making deploy script executable..."
            chmod +x deploy-blue-green.sh

            echo "üîÑ Executing Blue/Green deployment..."
            ./deploy-blue-green.sh

            echo "üìä Final container status:"
            docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.Status}}'

            echo "‚úÖ Blue/Green deployment completed successfully!"
          EOF