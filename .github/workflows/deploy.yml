name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  BACKEND_IMAGE: ze2l/ppituruppaturu-backend
  FRONTEND_IMAGE: ze2l/ppituruppaturu-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./pp-backend
        push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        tags: ${{ env.BACKEND_IMAGE }}:latest,${{ env.BACKEND_IMAGE }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./pp-frontend
        push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        tags: ${{ env.FRONTEND_IMAGE }}:latest,${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NEXT_PUBLIC_KAKAO_CLIENT_ID=${{ secrets.NEXT_PUBLIC_KAKAO_CLIENT_ID || '982038156c0f5d51eac72ac1912db622' }}
          NEXT_PUBLIC_SITE_URL=https://ppituruppaturu.com

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && secrets.HOST && secrets.SSH_PRIVATE_KEY

    steps:
    - name: Deploy to production
      if: ${{ secrets.HOST && secrets.USERNAME && secrets.SSH_PRIVATE_KEY }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/pitturu
          ./deploy-blue-green.sh

    - name: Build Summary (No Secrets)
      if: ${{ !secrets.DOCKERHUB_USERNAME || !secrets.DOCKERHUB_TOKEN }}
      run: |
        echo "## 🛠️ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docker images built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ⚠️ Images not pushed (Docker Hub secrets not configured)" >> $GITHUB_STEP_SUMMARY
        echo "- ⚠️ Deployment skipped (SSH secrets not configured)" >> $GITHUB_STEP_SUMMARY
        echo "- 💡 Configure GitHub Secrets to enable full CI/CD" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Summary
      if: ${{ secrets.HOST && secrets.USERNAME && secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "## 🎉 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docker images built and pushed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Production deployment completed" >> $GITHUB_STEP_SUMMARY
        echo "- 🚀 Live at https://ppituruppaturu.com" >> $GITHUB_STEP_SUMMARY
