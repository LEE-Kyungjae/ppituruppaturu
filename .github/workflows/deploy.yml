name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ë¨¼ì € ë¹Œë“œ ì™„ë£Œ í™•ì¸
  check-build:
    runs-on: ubuntu-latest
    outputs:
      backend-exists: ${{ steps.check.outputs.backend-exists }}
      frontend-exists: ${{ steps.check.outputs.frontend-exists }}

    steps:
      - name: Check if images exist
        id: check
        run: |
          # GitHub Container Registryì—ì„œ ì´ë¯¸ì§€ í™•ì¸
          if docker manifest inspect ghcr.io/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} > /dev/null 2>&1; then
            echo "backend-exists=true" >> $GITHUB_OUTPUT
          else
            echo "backend-exists=false" >> $GITHUB_OUTPUT
          fi

          if docker manifest inspect ghcr.io/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} > /dev/null 2>&1; then
            echo "frontend-exists=true" >> $GITHUB_OUTPUT
          else
            echo "frontend-exists=false" >> $GITHUB_OUTPUT
          fi

  # ì‹¤ì œ ë°°í¬
  deploy:
    needs: check-build
    if: needs.check-build.outputs.backend-exists == 'true' && needs.check-build.outputs.frontend-exists == 'true'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Deploy to server
        run: |
          # Known hosts ì¶”ê°€
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

          # ì„œë²„ì— ë°°í¬
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /opt/pitturu || {
              echo "âŒ /opt/pitturu ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. pp-infraì—ì„œ í™˜ê²½ ì„¤ì •ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”."
              exit 1
            }

            # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì•ˆì „í•˜ê²Œ)
            if [ -f docker-compose.prod.yml ]; then
              docker-compose -f docker-compose.prod.yml down
            fi

            # ìƒˆ ì´ë¯¸ì§€ í’€
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}

            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export BACKEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}"
            export FRONTEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}"

            # docker-compose.ymlì„ ì´ë¯¸ì§€ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •
            cat > docker-compose.prod.yml << 'COMPOSE_EOF'
          version: '3.8'
          services:
            postgres:
              image: postgres:15-alpine
              restart: unless-stopped
              environment:
                POSTGRES_DB: ${POSTGRES_DB:-pitturu_db}
                POSTGRES_USER: ${POSTGRES_USER:-postgres}
                POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
              ports:
                - "5432:5432"
              volumes:
                - postgres_data:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
                interval: 30s
                timeout: 10s
                retries: 3

            redis:
              image: redis:7-alpine
              restart: unless-stopped
              ports:
                - "6379:6379"
              volumes:
                - redis_data:/data

            backend:
              image: ${BACKEND_IMAGE}
              restart: unless-stopped
              ports:
                - "8080:8080"
                - "8082:8082"
              environment:
                - DSN=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-pitturu_db}?sslmode=disable
                - REDIS_URL=redis://redis:6379
                - JWT_SECRET=${JWT_SECRET}
                - REFRESH_SECRET=${REFRESH_SECRET}
              depends_on:
                postgres:
                  condition: service_healthy

            frontend:
              image: ${FRONTEND_IMAGE}
              restart: unless-stopped
              ports:
                - "3000:3000"
              environment:
                - NEXT_PUBLIC_API_URL=https://api.ppituruppaturu.com
                - NEXT_PUBLIC_WS_URL=wss://api.ppituruppaturu.com
              depends_on:
                - backend

          volumes:
            postgres_data:
            redis_data:
          COMPOSE_EOF

            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f .env ]; then
              echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”."
              exit 1
            fi

            # ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose -f docker-compose.prod.yml up -d

            # í—¬ìŠ¤ì²´í¬ (30ì´ˆ ëŒ€ê¸° í›„)
            echo "ğŸ” í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
            sleep 30

            if curl -f http://localhost:8080/health; then
              echo "âœ… Backend ì •ìƒ"
            else
              echo "âŒ Backend ì‹¤íŒ¨"
              exit 1
            fi

            if curl -f http://localhost:3000; then
              echo "âœ… Frontend ì •ìƒ"
            else
              echo "âŒ Frontend ì‹¤íŒ¨"
              exit 1
            fi

            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -af --filter "until=24h"

            echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          EOF

      - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ: https://ppituruppaturu.com"
          else
            echo "âŒ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨"
          fi